version: '3'

tasks:
  help:
    desc: Show this help message
    cmds:
    - task --list

  install:
    desc: Install all dependencies
    cmds:
    - pnpm install

  dev:
    desc: Run all apps in development mode
    cmds:
    - pnpm dev

  start:
    desc: Run all apps in production mode
    cmds:
    - pnpm start

  build:
    desc: Build all apps
    cmds:
    - pnpm build

  clean:
    desc: Clean all node_modules
    cmds:
    - pnpm clean
    - rm -rf node_modules

  docker:build:
    desc: Build all Docker images (web, docs, uptime-kuma)
    cmds:
    - docker compose build --no-cache

  docker:up:
    desc: Start all Docker containers with persistent data
    cmds:
    - docker compose up -d
    - |
      echo "â³ Waiting for services to be ready..."
      timeout 60 sh -c 'until docker compose ps | grep -q "healthy\|running"; do sleep 2; done' || echo "âš ï¸  Services may still be starting"
    - task: search:index

  docker:down:
    desc: Stop all Docker containers
    cmds:
    - docker compose down

  docker:restart:
    desc: Restart all Docker containers
    cmds:
    - docker compose restart

  docker:logs:
    desc: View logs from all Docker containers
    cmds:
    - docker compose logs -f

  docker:logs:web:
    desc: View logs from web container only
    cmds:
    - docker compose logs -f web

  docker:logs:docs:
    desc: View logs from docs container only
    cmds:
    - docker compose logs -f docs

  docker:logs:uptime:
    desc: View logs from uptime-kuma container only
    cmds:
    - docker compose logs -f uptime-kuma

  docker:status:
    desc: Show status of all containers including Meilisearch
    cmds:
    - docker compose ps

  docker:clean:
    desc: Clean up Docker containers, networks, and volumes
    cmds:
    - docker compose down -v
    - docker system prune -f

  services:info:
    desc: Show information about running services
    cmds:
    - |
      echo "ğŸŒ Web Frontend:      http://localhost:8080"
      echo "ğŸ“š Documentation:    http://localhost:8081"
      echo "ğŸ“Š Status Monitor:   http://localhost:3001"
      echo "ğŸ” Search (Meilisearch): http://localhost:7700"
      echo ""
      echo "Container Status:"
      docker compose ps

  setup:macos:
    desc: Setup macOS auto-startup (requires manual path update in plist file)
    cmds:
    - |
      echo "Before running this, update the WorkingDirectory path in macos/com.doc.docker-compose.plist"
      read -p "Have you updated the path? (y/n) " -n 1 -r
      echo
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        cp macos/com.doc.docker-compose.plist ~/Library/LaunchAgents/
        launchctl load ~/Library/LaunchAgents/com.doc.docker-compose.plist
        echo "âœ… LaunchAgent installed and loaded"
      else
        echo "âŒ Setup cancelled. Please update the path first."
      fi

  docs:dev:
    desc: Start Antora documentation development server with watch mode
    dir: apps/docs
    cmds:
    - pnpm watch

  docs:build:
    desc: Build Antora documentation
    dir: apps/docs
    cmds:
    - pnpm build
    - task: search:index

  docs:serve:
    desc: Serve built Antora documentation
    dir: apps/docs
    cmds:
    - pnpm serve

  search:index:
    desc: Index documentation in Meilisearch
    dir: apps/docs/indexer
    cmds:
    - |
      echo "â³ Waiting for Meilisearch to be ready..."
      timeout 30 sh -c '
        while ! curl -s http://localhost:7700/health > /dev/null 2>&1; do
          echo "Waiting for Meilisearch..."
          sleep 2
        done
      ' || { echo "âŒ Meilisearch not ready after 30s"; exit 1; }
      echo "ğŸ” Indexing documentation..."
      node index.js

  search:status:
    desc: Check Meilisearch status and document count
    cmds:
    - |
      echo "ğŸ” Meilisearch Status:"
      curl -s http://localhost:7700/health || echo "âŒ Meilisearch not accessible"
      echo ""
      echo "ğŸ“Š Document Count:"
      curl -s "http://localhost:7700/indexes/docs/stats" -H "Authorization: Bearer masterKey123" | grep -o '"numberOfDocuments":[0-9]*' || echo "âŒ Cannot retrieve stats"

  search:clear:
    desc: Clear all documents from Meilisearch index
    cmds:
    - |
      echo "ğŸ—‘ï¸ Clearing Meilisearch index..."
      curl -X DELETE "http://localhost:7700/indexes/docs/documents" -H "Authorization: Bearer masterKey123"
      echo "âœ… Index cleared"

  search:test:
    desc: Test search functionality
    cmds:
    - |
      echo "ğŸ” Testing search for 'installation':"
      curl -s "http://localhost:7700/indexes/docs/search" \
        -H "Authorization: Bearer masterKey123" \
        -H "Content-Type: application/json" \
        -d '{"q": "installation", "limit": 3}' | \
        grep -o '"title":"[^"]*"' | head -3 || echo "âŒ Search failed"

  docker:logs:meilisearch:
    desc: View logs from Meilisearch container only
    cmds:
    - docker compose logs -f meilisearch
